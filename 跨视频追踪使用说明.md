# 跨视频人物追踪功能使用说明

## 功能介绍

这个功能可以让你：
1. **加载多个视频**
2. **点击选择要追踪的目标人物**
3. **自动在所有视频中搜索该人物**
4. **查看搜索结果**（包括出现的视频、时间、截图）

## 使用步骤

### 第1步：打开跨视频追踪页面

1. 运行程序：`python main.py`
2. 在主界面顶部点击 **"Cross-Camera Tracking"** 按钮

### 第2步：添加视频

1. 点击左侧的 **"+ 添加视频"** 按钮
2. 选择多个视频文件（支持 .mp4, .avi, .mov, .mkv）
3. 视频会显示在左侧列表中

**提示**：
- 可以一次选择多个视频
- 建议视频数量：2-10个（太多会很慢）

### 第3步：选择追踪目标

1. 点击右侧的 **"从视频中选择目标"** 按钮
2. 会打开目标选择对话框，显示第一个视频

**在对话框中**：
- 使用滑块或 "上一帧/下一帧" 按钮浏览视频
- 点击画面中的任意人物（会显示绿色框和衣服颜色）
- 选中后会显示黄色高亮框和 "SELECTED" 标记
- 点击 **"确认选择"** 完成选择

**提示**：
- 选择穿着特征明显的人物（如颜色鲜艳的衣服）
- 避免选择被遮挡或模糊的人物

### 第4步：开始搜索

1. 选择目标后，右侧会显示目标人物的预览图
2. 点击 **"开始搜索"** 按钮
3. 进度条会显示搜索进度
4. 找到的结果会实时显示在下方

### 第5步：查看结果

搜索完成后，结果区域会显示所有找到的位置：

每个结果包含：
- **缩略图**：目标人物的截图
- **视频名称**：出现在哪个视频中
- **时间**：出现的时间点（分:秒）
- **颜色**：检测到的衣服颜色

## 界面说明

```
┌─────────────────────────────────────────────────────┐
│  跨视频人物追踪                                        │
│  1. 加载多个视频  2. 点击选择目标人物  3. 开始搜索      │
├──────────────┬──────────────────────────────────────┤
│              │  选择追踪目标                          │
│ 已加载视频    │  从任意视频中点击选择要追踪的人物        │
│              │  ┌──────────────────────────────┐    │
│ + 添加视频    │  │从视频中选择目标 (按钮)        │    │
│              │  └──────────────────────────────┘    │
│ 📹 video1.mp4│  ┌──────────────────────────────┐    │
│ 📹 video2.mp4│  │     [目标预览图]             │    │
│ 📹 video3.mp4│  │                              │    │
│              │  └──────────────────────────────┘    │
│ [清空列表]    │  ┌──────────────────────────────┐    │
│              │  │    开始搜索 (按钮)           │    │
│              │  └──────────────────────────────┘    │
│              │  ━━━━━━━━━━ 50% ━━━━━━━━━━         │
│              │                                     │
│              │  搜索结果                            │
│              │  ┌──────────────────────────────┐  │
│              │  │ 📷 | 视频: video2.mp4       │  │
│              │  │    | 时间: 2:35             │  │
│              │  │    | 颜色: Blue             │  │
│              │  └──────────────────────────────┘  │
└──────────────┴──────────────────────────────────────┘
```

## 参数调整

### 搜索精度 (在代码中调整)

打开 `src/ui/tracking_page.py`，找到第426行：

```python
similarity_threshold=0.5  # 可调整
```

**调整建议**：
- `0.3-0.4`：宽松匹配，找到更多可能结果（可能误报）
- `0.5`：平衡模式（默认）
- `0.6-0.7`：严格匹配，只找高度相似的（可能漏报）

### 搜索速度 (在代码中调整)

打开 `src/ui/tracking_page.py`，找到第364行：

```python
# 每30帧检测一次（加速搜索）
if frame_count % 30 != 0:
```

**调整建议**：
- `% 15`：更快检测，更准确，但速度慢
- `% 30`：平衡（默认）
- `% 60`：更快，但可能漏掉短暂出现的人物

## 常见问题

### Q1: 搜索速度很慢怎么办？

**解决方法**：
1. 减少视频数量
2. 使用分辨率较低的视频
3. 调大帧跳过间隔（改为 `% 60`）

### Q2: 找不到目标或找到错误的人？

**原因**：
- 光线、角度变化大
- 目标穿着改变
- 相似外观的人太多

**解决方法**：
1. 调低 `similarity_threshold` 到 0.4
2. 选择穿着更有特色的人物
3. 确保目标在选择时清晰可见

### Q3: 结果太多，有很多误报？

**解决方法**：
1. 调高 `similarity_threshold` 到 0.6-0.7
2. 选择穿着更独特的目标

### Q4: 没有找到任何结果？

**可能原因**：
- 阈值设置太高
- 目标确实不在其他视频中
- 目标外观变化太大

**解决方法**：
1. 降低阈值到 0.3
2. 确认目标是否真的在视频中出现

## 性能优化建议

### 对于大量视频 (10+)

1. **分批处理**：不要一次加载所有视频，分成2-3批
2. **预处理**：先在一个视频中确认目标清晰可见
3. **硬件**：使用带GPU的电脑会快很多

### 对于长视频 (30分钟+)

1. **分段**：使用视频编辑软件先分段
2. **采样**：调大帧跳过间隔到 `% 60` 或 `% 90`

## 技术说明

### 工作原理

1. **ReID特征提取**：
   - 提取目标的外观特征（颜色、纹理）
   - 生成512维特征向量

2. **相似度计算**：
   - 使用余弦相似度比对特征
   - 相似度 > 阈值则判定为同一人

3. **多线程搜索**：
   - 后台线程处理视频
   - 不阻塞UI界面

### 局限性

- **外观变化**：穿着改变、戴帽子等会影响识别
- **光线影响**：室内室外光线差异大会降低准确度
- **角度问题**：正面和背面的特征差异大
- **遮挡问题**：被遮挡的人物难以识别

## 未来改进

计划中的功能：
1. **FastReID集成**：更准确的特征提取
2. **实时预览**：搜索时显示当前处理的帧
3. **结果导出**：导出搜索结果到文件
4. **批量追踪**：同时追踪多个目标

## 反馈

如有问题或建议，请联系开发团队。
